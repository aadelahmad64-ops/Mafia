<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø§ÙÙŠØ§ Â· Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…ØªØ±Ø§Ø¨Ø·Ø©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Cairo', Tahoma, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2639 0%, #0f172a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }
        
        .game-container {
            max-width: 600px;
            width: 100%;
            background: rgba(20, 30, 40, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 48px;
            padding: 24px 16px;
            box-shadow: 0 25px 50px -8px #000000cc;
            border: 2px solid #4b6584;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #f7d794;
            font-size: 2.5rem;
            text-shadow: 0 3px 0 #b85e00;
        }
        
        .room-card {
            background: #1e2b3a;
            border-radius: 40px;
            padding: 20px;
            margin: 15px 0;
            border: 3px solid #546e7a;
        }
        
        .room-code {
            background: #0f1a24;
            padding: 20px;
            border-radius: 60px;
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 10px;
            text-align: center;
            color: #fadf9e;
            border: 3px dashed #c29a4f;
            direction: ltr;
        }
        
        .input-field {
            background: #0f1a24;
            border: 3px solid #3f5563;
            border-radius: 60px;
            padding: 18px;
            width: 100%;
            font-size: 1.2rem;
            color: white;
            text-align: center;
            margin: 10px 0;
        }
        
        .btn {
            background: #2c3e50;
            border: none;
            color: white;
            padding: 18px 24px;
            border-radius: 60px;
            font-size: 1.4rem;
            font-weight: bold;
            width: 100%;
            margin: 8px 0;
            box-shadow: 0 6px 0 #1a2632;
            cursor: pointer;
            transition: 0.1s;
            border: 2px solid #6d8a9e;
        }
        
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1a2632;
        }
        
        .btn.success {
            background: #27ae60;
            box-shadow: 0 6px 0 #1e7e4b;
            border-color: #a5d6a7;
        }
        
        .btn.danger {
            background: #c0392b;
            box-shadow: 0 6px 0 #8b2c1e;
        }
        
        .players-grid {
            background: #1e2b3a;
            border-radius: 40px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .player-item {
            background: #2c3f4e;
            padding: 16px;
            margin: 8px 0;
            border-radius: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.3rem;
            border: 2px solid #5f7e94;
            color: white;
        }
        
        .player-item.host {
            border: 3px solid gold;
            background: #3f3a1a;
        }
        
        .role-card {
            background: #1e2f3a;
            border-radius: 50px;
            padding: 30px;
            text-align: center;
            border: 4px solid #c29a4f;
            margin: 15px 0;
        }
        
        .role-name {
            font-size: 3.5rem;
            font-weight: 900;
            color: #f7d794;
            background: #0f1f2b;
            padding: 20px;
            border-radius: 60px;
            margin: 15px 0;
        }
        
        .phase-badge {
            background: #17212b;
            padding: 16px;
            border-radius: 50px;
            font-size: 1.8rem;
            color: #f7d794;
            text-align: center;
            border: 3px solid #a97c4b;
        }
        
        .target-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        
        .target-option {
            background: #2c4053;
            border: 3px solid #5c7a92;
            padding: 20px 8px;
            border-radius: 40px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }
        
        .target-option.selected {
            background: #b85e00;
            border-color: #ffc107;
            transform: scale(1.03);
            box-shadow: 0 0 20px orange;
        }
        
        .hidden {
            display: none !important;
        }
        
        .waiting-room {
            background: #17212b;
            border-radius: 40px;
            padding: 30px;
            text-align: center;
            color: #e0bb7c;
            font-size: 1.6rem;
        }
        
        .connection-status {
            text-align: center;
            color: #7ed6df;
            margin: 5px;
            font-size: 1rem;
        }
    </style>
</head>
<body dir="rtl">
    <div class="game-container" id="app">
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
        <div id="connectionScreen">
            <div class="header">
                <h1>ğŸ® Ø§Ù„Ù…Ø§ÙÙŠØ§ ğŸ®</h1>
                <p style="color: #a5b9c9;">Ù„Ø¹Ø¨ Ø¬Ù…Ø§Ø¹ÙŠ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</p>
            </div>
            
            <div class="room-card">
                <input type="text" id="playerName" class="input-field" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="15" value="Ù„Ø§Ø¹Ø¨">
                
                <button class="btn success" id="createRoomBtn">â• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                
                <div style="margin: 20px 0; text-align: center; color: #94a9b9;">â€”â€” Ø£Ùˆ â€”â€”</div>
                
                <input type="text" id="roomCodeInput" class="input-field" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" maxlength="6">
                <button class="btn" id="joinRoomBtn">ğŸ”‘ Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</button>
            </div>
            
            <div class="connection-status" id="firebaseStatus">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        </div>
        
        <!-- Ø´Ø§Ø´Ø© ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
        <div id="lobbyScreen" class="hidden">
            <div class="header">
                <h1>â³ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h1>
            </div>
            
            <div class="room-card">
                <div style="color:#b3d4e9; font-size:1.2rem;">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</div>
                <div class="room-code" id="roomCodeDisplay">ABC123</div>
                <div style="color:#a0b9ce; margin-top:10px;">Ø£Ø±Ø³Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</div>
            </div>
            
            <div class="players-grid">
                <h3 style="color:#f0d494;">ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (<span id="playerCount">0</span>/10)</h3>
                <div id="playersList"></div>
            </div>
            
            <button class="btn success" id="startGameBtn">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (5+ Ù„Ø§Ø¹Ø¨ÙŠÙ†)</button>
            <button class="btn danger" id="leaveRoomBtn">âª Ù…ØºØ§Ø¯Ø±Ø©</button>
        </div>
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="gameScreen" class="hidden">
            <div class="phase-badge" id="phaseDisplay">ğŸŒ‘ Ù„ÙŠÙ„Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§</div>
            
            <div class="role-card" id="roleCard">
                <div style="color:#ffd966; font-size:1.6rem;">Ø¯ÙˆØ±Ùƒ</div>
                <div class="role-name" id="playerRole">???</div>
                <div id="roleDescription" style="color:#b7d7f0; font-size:1.2rem;">...</div>
            </div>
            
            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØª -->
            <div id="deadMessage" class="waiting-room hidden" style="background:#3d1e1e; color:#ffa7a7;">
                ğŸ’€ Ø£Ù†Øª Ù…ÙŠØª - ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ’€
            </div>
            
            <!-- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± -->
            <div id="waitingArea" class="waiting-room">
                â° Ø§Ù†ØªØ¸Ø± Ø¯ÙˆØ±Ùƒ...
            </div>
            
            <!-- Ø§Ù„Ù…Ø§ÙÙŠØ§ -->
            <div id="mafiaArea" class="hidden">
                <div style="color:#ffbc8c; font-size:1.8rem;">ğŸ”ª Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ Ù„Ù„Ù‚ØªÙ„</div>
                <div id="mafiaVotesCounter" style="color:#b7e0ff;">Ø§Ù„Ø£ØµÙˆØ§Øª: 0/2</div>
                <div class="target-buttons" id="mafiaTargets"></div>
                <button class="btn danger" id="confirmMafiaVote">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚ØªÙ„</button>
            </div>
            
            <!-- Ø§Ù„Ù…Ø­Ù‚Ù‚ -->
            <div id="detectiveArea" class="hidden">
                <div style="color:#b7e0ff; font-size:1.8rem;">ğŸ•µï¸ Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ ØªØ³ØªØ¬ÙˆØ¨Ù‡</div>
                <div class="target-buttons" id="detectiveTargets"></div>
                <button class="btn" id="confirmDetective">Ø§Ø³ØªØ¬ÙˆØ§Ø¨</button>
                <div id="detectiveResult" style="background:#1f3845; padding:20px; border-radius:40px; margin-top:20px; font-size:1.5rem;"></div>
            </div>
            
            <!-- Ø§Ù„Ø¯ÙƒØªÙˆØ± -->
            <div id="doctorArea" class="hidden">
                <div style="color:#bfffc7; font-size:1.8rem;">ğŸ’Š Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ Ù„ØªØ­Ù…ÙŠÙ‡</div>
                <div class="target-buttons" id="doctorTargets"></div>
                <button class="btn success" id="confirmDoctor">Ø­Ù…Ø§ÙŠØ©</button>
            </div>
            
            <!-- Ø§Ù„Ù†Ù‡Ø§Ø± -->
            <div id="dayArea" class="hidden">
                <div style="background:#2a3d33; padding:25px; border-radius:50px;">
                    <div style="font-size:2rem; color:#ffdb9f;" id="killResult">ğŸ” Ù„Ù… ÙŠÙ…Øª Ø£Ø­Ø¯</div>
                    <div style="font-size:1.3rem; color:#c7d5dd;" id="savedInfo"></div>
                </div>
                <button class="btn" id="nextNightBtn">ğŸŒ™ Ø§Ù„Ù„ÙŠÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
            </div>
            
            <!-- Ø²Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø§ÙÙŠØ§ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø§ÙÙŠØ§) -->
            <div id="mafiaFriends" style="background:#281e1e; border-radius:40px; padding:15px; margin-top:15px; color:#ffc9c9;" class="hidden"></div>
        </div>
    </div>

    <!-- Firebase SDK (Compatible version) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ====================
        const firebaseConfig = {
            apiKey: "AIzaSyABWL8YlvArWgFRo7qW4hk1GEOmbP1cbj8",
            authDomain: "mafia-51cfb.firebaseapp.com",
            databaseURL: "https://mafia-51cfb-default-rtdb.firebaseio.com",
            projectId: "mafia-51cfb",
            storageBucket: "mafia-51cfb.firebasestorage.app",
            messagingSenderId: "698628612652",
            appId: "1:698628612652:web:0437f9af05e38185852789",
            measurementId: "G-C52PJ72330"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        document.getElementById('firebaseStatus').innerText = 'âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        
        // ==================== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ====================
        let currentPlayerId = localStorage.getItem('mafia_player_id');
        if (!currentPlayerId) {
            currentPlayerId = 'player_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('mafia_player_id', currentPlayerId);
        }
        
        let currentRoomCode = null;
        let isHost = false;
        let playerName = '';
        
        // Ø¹Ù†Ø§ØµØ± DOM
        const connectionScreen = document.getElementById('connectionScreen');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        
        // ==================== Ø¯ÙˆØ§Ù„ Firebase ====================
        function getRoomRef(roomCode) {
            return database.ref('rooms/' + roomCode);
        }
        
        function createRoom() {
            playerName = document.getElementById('playerName').value.trim() || 'Ù…Ø¶ÙŠÙ';
            
            // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† 6 Ø£Ø­Ø±Ù
            const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const roomData = {
                hostId: currentPlayerId,
                players: {
                    [currentPlayerId]: {
                        id: currentPlayerId,
                        name: playerName,
                        isHost: true,
                        role: null,
                        isDead: false,
                        vote: null
                    }
                },
                phase: 'lobby',
                round: 0,
                mafiaVotes: {},
                detectiveTarget: null,
                doctorTarget: null,
                killedPlayer: null,
                savedPlayer: null,
                detectiveResult: null,
                nightIndex: 0,
                mafiaConfirmed: {},
                detectiveConfirmed: false,
                doctorConfirmed: false,
                createdAt: Date.now()
            };
            
            getRoomRef(roomCode).set(roomData)
                .then(() => {
                    currentRoomCode = roomCode;
                    isHost = true;
                    listenToRoom(roomCode);
                    showLobby();
                })
                .catch(error => {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + error.message);
                });
        }
        
        function joinRoom() {
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!roomCode) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
                return;
            }
            
            playerName = document.getElementById('playerName').value.trim() || 'Ù„Ø§Ø¹Ø¨';
            
            getRoomRef(roomCode).once('value', snapshot => {
                if (!snapshot.exists()) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±ÙØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯');
                    return;
                }
                
                const roomData = snapshot.val();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                if (roomData.players && Object.keys(roomData.players).length >= 10) {
                    alert('Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©');
                    return;
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
                const updates = {};
                updates[`/rooms/${roomCode}/players/${currentPlayerId}`] = {
                    id: currentPlayerId,
                    name: playerName,
                    isHost: false,
                    role: null,
                    isDead: false,
                    vote: null
                };
                
                firebase.database().ref().update(updates)
                    .then(() => {
                        currentRoomCode = roomCode;
                        isHost = (roomData.hostId === currentPlayerId);
                        listenToRoom(roomCode);
                        
                        if (roomData.phase === 'lobby') {
                            showLobby();
                        } else {
                            showGame();
                        }
                    });
            });
        }
        
        function listenToRoom(roomCode) {
            getRoomRef(roomCode).on('value', snapshot => {
                if (!snapshot.exists()) {
                    // Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø±Ø¨Ù…Ø§ Ø­Ø°ÙØª)
                    alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
                    backToConnection();
                    return;
                }
                
                const roomData = snapshot.val();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø§ ÙŠØ²Ø§Ù„ ÙÙŠ Ø§Ù„ØºØ±ÙØ©
                if (!roomData.players || !roomData.players[currentPlayerId]) {
                    // Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„ØºØ±ÙØ©
                    alert('ØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ©');
                    backToConnection();
                    return;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                if (lobbyScreen.classList.contains('hidden') === false) {
                    renderLobby(roomData);
                } else if (gameScreen.classList.contains('hidden') === false) {
                    renderGame(roomData);
                }
            });
        }
        
        // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø§Øª ====================
        function showLobby() {
            connectionScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            
            document.getElementById('roomCodeDisplay').innerText = currentRoomCode;
        }
        
        function showGame() {
            connectionScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
        }
        
        function backToConnection() {
            if (currentRoomCode) {
                getRoomRef(currentRoomCode).off();
            }
            currentRoomCode = null;
            connectionScreen.classList.remove('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
        }
        
        // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙˆØ¨ÙŠ ====================
        function renderLobby(roomData) {
            const players = Object.values(roomData.players || {});
            const playersList = document.getElementById('playersList');
            const playerCount = document.getElementById('playerCount');
            
            let html = '';
            players.forEach(p => {
                html += `<div class="player-item ${p.isHost ? 'host' : ''}">
                    <span>${p.name}</span>
                    <span>${p.isHost ? 'ğŸ‘‘' : 'âœ…'}</span>
                </div>`;
            });
            playersList.innerHTML = html;
            playerCount.innerText = players.length;
            
            // Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ù…Ø¶ÙŠÙ ÙÙ‚Ø·)
            const startBtn = document.getElementById('startGameBtn');
            if (isHost && players.length >= 5) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }
        
        // ==================== Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ====================
        function startGame() {
            if (!isHost) return;
            
            getRoomRef(currentRoomCode).once('value', snapshot => {
                const roomData = snapshot.val();
                const players = Object.values(roomData.players);
                
                if (players.length < 5) {
                    alert('ØªØ­ØªØ§Ø¬ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }
                
                // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
                const roles = [];
                const playerCount = players.length;
                
                // 2 Ù…Ø§ÙÙŠØ§ Ø¥Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø¯ 5-7ØŒ 3 Ù…Ø§ÙÙŠØ§ Ø¥Ø°Ø§ 8+
                let mafiaCount = 2;
                if (playerCount >= 8) mafiaCount = 3;
                
                for (let i = 0; i < playerCount; i++) {
                    if (i < mafiaCount) roles.push('Ù…Ø§ÙÙŠØ§');
                    else if (i === mafiaCount) roles.push('Ù…Ø­Ù‚Ù‚');
                    else if (i === mafiaCount + 1) roles.push('Ø¯ÙƒØªÙˆØ±');
                    else roles.push('Ù…ÙˆØ§Ø·Ù†');
                }
                
                // Ø®Ù„Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                const updates = {};
                const playerIds = Object.keys(roomData.players);
                playerIds.forEach((id, index) => {
                    updates[`/rooms/${currentRoomCode}/players/${id}/role`] = roles[index];
                    updates[`/rooms/${currentRoomCode}/players/${id}/isDead`] = false;
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
                updates[`/rooms/${currentRoomCode}/phase`] = 'mafiaNight';
                updates[`/rooms/${currentRoomCode}/round`] = 1;
                updates[`/rooms/${currentRoomCode}/mafiaVotes`] = {};
                updates[`/rooms/${currentRoomCode}/detectiveTarget`] = null;
                updates[`/rooms/${currentRoomCode}/doctorTarget`] = null;
                updates[`/rooms/${currentRoomCode}/killedPlayer`] = null;
                updates[`/rooms/${currentRoomCode}/savedPlayer`] = null;
                updates[`/rooms/${currentRoomCode}/nightIndex`] = 0;
                
                firebase.database().ref().update(updates);
            });
        }
        
        // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¹Ø¨Ø© ====================
        function renderGame(roomData) {
            const myPlayer = roomData.players[currentPlayerId];
            if (!myPlayer) return;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
            const phaseMap = {
                'mafiaNight': 'ğŸŒ‘ Ù„ÙŠÙ„Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§',
                'detectiveNight': 'ğŸ” Ù„ÙŠÙ„Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚',
                'doctorNight': 'ğŸ’Š Ù„ÙŠÙ„Ø© Ø§Ù„Ø¯ÙƒØªÙˆØ±',
                'day': 'â˜€ï¸ Ø§Ù„Ù†Ù‡Ø§Ø±'
            };
            document.getElementById('phaseDisplay').innerText = phaseMap[roomData.phase] + ` (Ø§Ù„Ù„ÙŠÙ„Ø© ${roomData.round})`;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ±
            document.getElementById('playerRole').innerText = myPlayer.role || '???';
            
            // ÙˆØµÙ Ø§Ù„Ø¯ÙˆØ±
            const descs = {
                'Ù…Ø§ÙÙŠØ§': 'Ø§Ù‚ØªÙ„ Ø´Ø®ØµØ§Ù‹ Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¦Ùƒ',
                'Ù…Ø­Ù‚Ù‚': 'Ø§Ø³ØªØ¬ÙˆØ¨ Ø´Ø®Øµ Ù„ØªØ¹Ø±Ù Ø¯ÙˆØ±Ù‡',
                'Ø¯ÙƒØªÙˆØ±': 'Ø§Ø­Ù… Ø´Ø®Øµ Ù…Ù† Ø§Ù„Ù…ÙˆØª',
                'Ù…ÙˆØ§Ø·Ù†': 'Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ø§ÙÙŠØ§'
            };
            document.getElementById('roleDescription').innerText = descs[myPlayer.role] || '';
            
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
            document.getElementById('waitingArea').classList.add('hidden');
            document.getElementById('mafiaArea').classList.add('hidden');
            document.getElementById('detectiveArea').classList.add('hidden');
            document.getElementById('doctorArea').classList.add('hidden');
            document.getElementById('dayArea').classList.add('hidden');
            document.getElementById('deadMessage').classList.add('hidden');
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙŠØª
            if (myPlayer.isDead) {
                document.getElementById('deadMessage').classList.remove('hidden');
                document.getElementById('waitingArea').classList.remove('hidden');
                document.getElementById('waitingArea').innerText = 'ğŸ’€ Ø£Ù†Øª Ù…ÙŠØª - ØªØ§Ø¨Ø¹ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙƒÙ…Ø´Ø§Ù‡Ø¯ ğŸ’€';
                return;
            }
            
            // Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§
            if (roomData.phase === 'mafiaNight' && myPlayer.role === 'Ù…Ø§ÙÙŠØ§') {
                showMafiaArea(roomData);
            }
            // Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚
            else if (roomData.phase === 'detectiveNight' && myPlayer.role === 'Ù…Ø­Ù‚Ù‚') {
                showDetectiveArea(roomData);
            }
            // Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯ÙƒØªÙˆØ±
            else if (roomData.phase === 'doctorNight' && myPlayer.role === 'Ø¯ÙƒØªÙˆØ±') {
                showDoctorArea(roomData);
            }
            // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‡Ø§Ø±
            else if (roomData.phase === 'day') {
                showDayArea(roomData);
            }
            // Ø§Ù†ØªØ¸Ø§Ø±
            else {
                document.getElementById('waitingArea').classList.remove('hidden');
            }
            
            // Ø¹Ø±Ø¶ Ø²Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø§ÙÙŠØ§
            if (myPlayer.role === 'Ù…Ø§ÙÙŠØ§' && !myPlayer.isDead) {
                const mafiaFriends = Object.values(roomData.players).filter(p => p.role === 'Ù…Ø§ÙÙŠØ§' && p.id !== currentPlayerId && !p.isDead);
                if (mafiaFriends.length > 0) {
                    const names = mafiaFriends.map(p => p.name).join('ØŒ ');
                    document.getElementById('mafiaFriends').innerText = `ğŸ”ª Ø²Ù…Ù„Ø§Ø¤Ùƒ: ${names}`;
                    document.getElementById('mafiaFriends').classList.remove('hidden');
                } else {
                    document.getElementById('mafiaFriends').classList.add('hidden');
                }
            } else {
                document.getElementById('mafiaFriends').classList.add('hidden');
            }
        }
        
        function showMafiaArea(roomData) {
            document.getElementById('mafiaArea').classList.remove('hidden');
            
            const playersAlive = Object.values(roomData.players).filter(p => !p.isDead && p.id !== currentPlayerId);
            const mafiaCount = Object.values(roomData.players).filter(p => p.role === 'Ù…Ø§ÙÙŠØ§' && !p.isDead).length;
            
            let html = '';
            playersAlive.forEach(p => {
                const selected = (roomData.mafiaVotes && roomData.mafiaVotes[currentPlayerId] === p.id) ? 'selected' : '';
                html += `<div class="target-option ${selected}" data-id="${p.id}" data-action="mafiaVote">${p.name}</div>`;
            });
            document.getElementById('mafiaTargets').innerHTML = html;
            
            // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª
            const votesCount = roomData.mafiaVotes ? Object.keys(roomData.mafiaVotes).length : 0;
            document.getElementById('mafiaVotesCounter').innerText = `Ø§Ù„Ø£ØµÙˆØ§Øª: ${votesCount}/${mafiaCount}`;
            
            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø±
            document.querySelectorAll('[data-action="mafiaVote"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.id;
                    const updates = {};
                    updates[`/rooms/${currentRoomCode}/mafiaVotes/${currentPlayerId}`] = targetId;
                    firebase.database().ref().update(updates);
                });
            });
        }
        
        function showDetectiveArea(roomData) {
            document.getElementById('detectiveArea').classList.remove('hidden');
            
            const playersAlive = Object.values(roomData.players).filter(p => !p.isDead);
            
            let html = '';
            playersAlive.forEach(p => {
                const selected = (roomData.detectiveTarget === p.id) ? 'selected' : '';
                html += `<div class="target-option ${selected}" data-id="${p.id}" data-action="detectiveTarget">${p.name}</div>`;
            });
            document.getElementById('detectiveTargets').innerHTML = html;
            
            document.querySelectorAll('[data-action="detectiveTarget"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.id;
                    const updates = {};
                    updates[`/rooms/${currentRoomCode}/detectiveTarget`] = targetId;
                    firebase.database().ref().update(updates);
                });
            });
            
            if (roomData.detectiveResult) {
                const target = Object.values(roomData.players).find(p => p.id === roomData.detectiveTarget);
                document.getElementById('detectiveResult').innerText = `ğŸ” Ø¯ÙˆØ± ${target?.name}: ${roomData.detectiveResult}`;
            }
        }
        
        function showDoctorArea(roomData) {
            document.getElementById('doctorArea').classList.remove('hidden');
            
            const playersAlive = Object.values(roomData.players).filter(p => !p.isDead);
            
            let html = '';
            playersAlive.forEach(p => {
                const selected = (roomData.doctorTarget === p.id) ? 'selected' : '';
                html += `<div class="target-option ${selected}" data-id="${p.id}" data-action="doctorTarget">${p.name}</div>`;
            });
            document.getElementById('doctorTargets').innerHTML = html;
            
            document.querySelectorAll('[data-action="doctorTarget"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.id;
                    const updates = {};
                    updates[`/rooms/${currentRoomCode}/doctorTarget`] = targetId;
                    firebase.database().ref().update(updates);
                });
            });
        }
        
        function showDayArea(roomData) {
            document.getElementById('dayArea').classList.remove('hidden');
            
            const killed = roomData.killedPlayer ? Object.values(roomData.players).find(p => p.id === roomData.killedPlayer) : null;
            const saved = roomData.savedPlayer ? Object.values(roomData.players).find(p => p.id === roomData.savedPlayer) : null;
            
            if (killed && !saved) {
                document.getElementById('killResult').innerText = `ğŸ”ª Ù‚ØªÙ„ Ø§Ù„Ù„ÙŠÙ„Ø©: ${killed.name}`;
                document.getElementById('savedInfo').innerText = '';
            } else if (killed && saved) {
                document.getElementById('killResult').innerText = `ğŸ›¡ï¸ Ù„Ù… ÙŠÙ…Øª Ø£Ø­Ø¯ (${saved.name} Ù…Ø­Ù…ÙŠ)`;
                document.getElementById('savedInfo').innerText = '';
            } else {
                document.getElementById('killResult').innerText = `âœ¨ Ù„Ù… ÙŠÙ…Øª Ø£Ø­Ø¯`;
            }
        }
        
        // ==================== ØªØ£ÙƒÙŠØ¯Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ====================
        document.getElementById('confirmMafiaVote').addEventListener('click', () => {
            getRoomRef(currentRoomCode).once('value', snapshot => {
                const roomData = snapshot.val();
                if (!roomData.mafiaVotes || !roomData.mafiaVotes[currentPlayerId]) {
                    alert('Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }
                
                const updates = {};
                updates[`/rooms/${currentRoomCode}/mafiaConfirmed/${currentPlayerId}`] = true;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø§ÙÙŠØ§
                const mafiaPlayers = Object.values(roomData.players).filter(p => p.role === 'Ù…Ø§ÙÙŠØ§' && !p.isDead);
                const confirmed = {...roomData.mafiaConfirmed, [currentPlayerId]: true};
                
                if (Object.keys(confirmed).length === mafiaPlayers.length && isHost) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ØªÙŠÙ„
                    const votes = roomData.mafiaVotes;
                    const voteCount = {};
                    Object.values(votes).forEach(targetId => {
                        voteCount[targetId] = (voteCount[targetId] || 0) + 1;
                    });
                    
                    let maxVotes = 0;
                    let killedId = null;
                    for (const [targetId, count] of Object.entries(voteCount)) {
                        if (count > maxVotes) {
                            maxVotes = count;
                            killedId = targetId;
                        }
                    }
                    
                    updates[`/rooms/${currentRoomCode}/killedPlayer`] = killedId;
                    updates[`/rooms/${currentRoomCode}/phase`] = 'detectiveNight';
                    updates[`/rooms/${currentRoomCode}/nightIndex`] = 1;
                }
                
                firebase.database().ref().update(updates);
            });
        });
        
        document.getElementById('confirmDetective').addEventListener('click', () => {
            getRoomRef(currentRoomCode).once('value', snapshot => {
                const roomData = snapshot.val();
                if (!roomData.detectiveTarget) {
                    alert('Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }
                
                const target = Object.values(roomData.players).find(p => p.id === roomData.detectiveTarget);
                
                const updates = {};
                updates[`/rooms/${currentRoomCode}/detectiveResult`] = target.role;
                updates[`/rooms/${currentRoomCode}/detectiveConfirmed`] = true;
                
                if (isHost) {
                    updates[`/rooms/${currentRoomCode}/phase`] = 'doctorNight';
                    updates[`/rooms/${currentRoomCode}/nightIndex`] = 2;
                }
                
                firebase.database().ref().update(updates);
            });
        });
        
        document.getElementById('confirmDoctor').addEventListener('click', () => {
            getRoomRef(currentRoomCode).once('value', snapshot => {
                const roomData = snapshot.val();
                if (!roomData.doctorTarget) {
                    alert('Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }
                
                const updates = {};
                updates[`/rooms/${currentRoomCode}/doctorConfirmed`] = true;
                
                if (isHost) {
                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ©
                    let saved = null;
                    if (roomData.doctorTarget === roomData.killedPlayer) {
                        saved = roomData.killedPlayer;
                    }
                    
                    // Ù‚ØªÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…ÙŠØ§Ù‹
                    if (roomData.killedPlayer && saved === null) {
                        updates[`/rooms/${currentRoomCode}/players/${roomData.killedPlayer}/isDead`] = true;
                    }
                    
                    updates[`/rooms/${currentRoomCode}/savedPlayer`] = saved;
                    updates[`/rooms/${currentRoomCode}/phase`] = 'day';
                }
                
                firebase.database().ref().update(updates);
            });
        });
        
        document.getElementById('nextNightBtn').addEventListener('click', () => {
            if (!isHost) return;
            
            const updates = {};
            updates[`/rooms/${currentRoomCode}/phase`] = 'mafiaNight';
            updates[`/rooms/${currentRoomCode}/round`] = firebase.database.ServerValue.increment(1);
            updates[`/rooms/${currentRoomCode}/mafiaVotes`] = {};
            updates[`/rooms/${currentRoomCode}/detectiveTarget`] = null;
            updates[`/rooms/${currentRoomCode}/doctorTarget`] = null;
            updates[`/rooms/${currentRoomCode}/killedPlayer`] = null;
            updates[`/rooms/${currentRoomCode}/savedPlayer`] = null;
            updates[`/rooms/${currentRoomCode}/detectiveResult`] = null;
            updates[`/rooms/${currentRoomCode}/mafiaConfirmed`] = {};
            updates[`/rooms/${currentRoomCode}/detectiveConfirmed`] = false;
            updates[`/rooms/${currentRoomCode}/doctorConfirmed`] = false;
            updates[`/rooms/${currentRoomCode}/nightIndex`] = 0;
            
            firebase.database().ref().update(updates);
        });
        
        // ==================== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØºØ±ÙØ© ====================
        document.getElementById('createRoomBtn').addEventListener('click', createRoom);
        document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
        document.getElementById('startGameBtn').addEventListener('click', startGame);
        
        document.getElementById('leaveRoomBtn').addEventListener('click', () => {
            if (currentRoomCode) {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„ØºØ±ÙØ©
                const updates = {};
                updates[`/rooms/${currentRoomCode}/players/${currentPlayerId}`] = null;
                firebase.database().ref().update(updates)
                    .then(() => {
                        backToConnection();
                    });
            }
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
        if (localStorage.getItem('player_name')) {
            document.getElementById('playerName').value = localStorage.getItem('player_name');
        }
        
        document.getElementById('playerName').addEventListener('change', (e) => {
            localStorage.setItem('player_name', e.target.value);
        });
    </script>
</body>
</html>